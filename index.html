<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FP&A Close Studio</title>
    <style>
      /* Salesforce Lightning Design System Colors + Design Tokens */
      :root {
        --bg: #FAFAF9; --bg-elev: #FFFFFF; --panel: #FFFFFF; --muted: #F3F2F2; --border: #C9C7C5;
        --text: #080707; --text-muted: #706E6B;
        --accent: #0176D3; --accent-ink: #FFFFFF; --warn: #FE9339; --ok: #2E844A; --info: #0176D3;
        --r-xs: 6px; --r-sm: 10px; --r-md: 14px; --r-lg: 20px;
        --shadow-1: 0 1px 2px rgba(16,24,40,.06), 0 1px 1px rgba(16,24,40,.04);
        --shadow-2: 0 10px 20px rgba(16,24,40,.10), 0 4px 6px rgba(16,24,40,.06);
        --s-1: 4px; --s-2: 8px; --s-3: 12px; --s-4: 16px; --s-5: 24px; --s-6: 32px;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Salesforce Sans", "Helvetica Neue", Arial, sans-serif;
      }
      [data-theme="dark"] {
        --bg: #181818; --bg-elev: #1B1B1B; --panel: #1B1B1B; --muted: #1B1B1B; --border: #474747;
        --text: #F3F3F3; --text-muted: #B0ADAB;
        --accent: #1B96FF; --accent-ink: #0B1220; --warn: #FE9339; --ok: #45C65A; --info: #1B96FF;
      }

      /* Base Reset */
      *, *::before, *::after { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; padding: 0; }
      body {
        font-family: var(--font);
        background: var(--bg);
        color: var(--text);
        line-height: 1.5;
        font-size: 14px;
        overflow: hidden;
      }

      /* App Shell - Lightning Style */
      .app-shell {
        display: grid;
        grid-template-areas: "header header header" "nav main aside";
        grid-template-columns: 240px 1fr 320px;
        grid-template-rows: 56px 1fr;
        height: 100vh;
      }

      /* Top Bar */
      .app-header {
        grid-area: header;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--s-4);
        background: var(--bg-elev);
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow-1);
        z-index: 100;
      }

      .app-title {
        display: flex;
        align-items: center;
        gap: var(--s-3);
        font-weight: 700;
        font-size: 16px;
        color: var(--text);
      }

      .app-badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: var(--r-xs);
        background: var(--muted);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .cmd-k-trigger {
        display: flex;
        align-items: center;
        gap: var(--s-2);
        padding: var(--s-2) var(--s-3);
        background: var(--muted);
        border: 1px solid var(--border);
        border-radius: var(--r-sm);
        cursor: pointer;
        min-width: 200px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .kbd {
        padding: 2px 6px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 11px;
        font-family: monospace;
      }

      /* Left Navigation */
      .app-nav {
        grid-area: nav;
        background: var(--panel);
        border-right: 1px solid var(--border);
        padding: var(--s-4);
        overflow-y: auto;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: var(--s-3);
        padding: var(--s-2) var(--s-3);
        border-radius: var(--r-sm);
        cursor: pointer;
        margin-bottom: var(--s-1);
        transition: all 0.15s ease;
        border: 1px solid transparent;
      }

      .nav-item:hover {
        background: var(--muted);
      }

      .nav-item.active {
        background: var(--accent);
        color: var(--accent-ink);
        border-color: var(--accent);
        box-shadow: var(--shadow-1);
      }

      /* Main Content */
      .app-main {
        grid-area: main;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--s-4) var(--s-5);
        border-bottom: 1px solid var(--border);
        background: var(--bg-elev);
      }

      .page-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: var(--text);
      }

      .page-content {
        flex: 1;
        padding: var(--s-5);
        overflow-y: auto;
      }

      /* Right Aside */
      .app-aside {
        grid-area: aside;
        background: var(--panel);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .aside-section {
        flex: 1;
        padding: var(--s-4);
        border-bottom: 1px solid var(--border);
        overflow-y: auto;
      }

      /* Command Palette */
      .cmd-palette {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding-top: 15vh;
        z-index: 1000;
      }

      .cmd-palette.active {
        display: flex;
      }

      .cmd-palette-content {
        background: var(--bg-elev);
        border-radius: var(--r-md);
        box-shadow: var(--shadow-2);
        width: 100%;
        max-width: 640px;
        max-height: 400px;
        display: flex;
        flex-direction: column;
      }

      .cmd-search {
        padding: var(--s-4);
        border: none;
        border-bottom: 1px solid var(--border);
        background: transparent;
        font-size: 16px;
        color: var(--text);
        outline: none;
      }

      .cmd-results {
        flex: 1;
        overflow-y: auto;
        padding: var(--s-2);
      }

      .cmd-item {
        display: flex;
        align-items: center;
        gap: var(--s-3);
        padding: var(--s-3);
        border-radius: var(--r-sm);
        cursor: pointer;
        margin-bottom: var(--s-1);
      }

      .cmd-item:hover,
      .cmd-item.selected {
        background: var(--accent);
        color: var(--accent-ink);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--s-2);
        padding: var(--s-2) var(--s-4);
        border-radius: var(--r-sm);
        border: 1px solid var(--border);
        background: var(--bg-elev);
        color: var(--text);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        text-decoration: none;
      }

      .btn:hover {
        background: var(--muted);
        transform: translateY(-1px);
      }

      .btn-primary {
        background: var(--accent);
        color: var(--accent-ink);
        border-color: var(--accent);
      }

      /* Cards */
      .card {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--r-md);
        box-shadow: var(--shadow-1);
        overflow: hidden;
        margin-bottom: var(--s-4);
      }

      .card-header {
        padding: var(--s-4);
        border-bottom: 1px solid var(--border);
        background: var(--muted);
      }

      .card-body {
        padding: var(--s-4);
      }

      /* Network Badge */
      .network-badge {
        position: fixed;
        bottom: var(--s-4);
        right: var(--s-4);
        padding: var(--s-2) var(--s-3);
        background: var(--ok);
        color: white;
        border-radius: var(--r-sm);
        font-size: 12px;
        font-weight: 600;
        z-index: 1000;
      }

      /* Scenario Cards */
      .scenario-board {
        display: flex;
        gap: var(--s-4);
        margin: var(--s-4) 0;
        overflow-x: auto;
        padding-bottom: var(--s-2);
      }

      .scenario-card {
        min-width: 280px;
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--r-md);
        padding: var(--s-4);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .scenario-card:hover {
        box-shadow: var(--shadow-2);
        transform: translateY(-2px);
      }

      .scenario-card.active {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
      }

      /* Utilities */
      .text-muted { color: var(--text-muted); }
      .text-small { font-size: 12px; }
      .font-weight-bold { font-weight: 600; }
      .d-flex { display: flex; }
      .justify-content-between { justify-content: space-between; }
      .mb-3 { margin-bottom: var(--s-3); }
      .mb-4 { margin-bottom: var(--s-4); }

      /* Responsive */
      @media (max-width: 1024px) {
        .app-shell {
          grid-template-columns: 60px 1fr 0;
        }
        .app-aside {
          display: none;
        }
      }

      /* Motion */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          transition-duration: 0.01ms !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- App Shell -->
    <div class="app-shell">
      <!-- Top Bar -->
      <header class="app-header">
        <div class="app-title">
          <span>FP&A Close Studio</span>
          <span class="app-badge">Offline Ready</span>
        </div>

        <div class="cmd-k-trigger" onclick="toggleCommandPalette()">
          <span>Quick actions...</span>
          <span class="kbd">⌘K</span>
        </div>

        <div class="d-flex" style="gap: var(--s-2);">
          <button class="btn" onclick="toggleTheme()" title="Toggle theme">🌗</button>
          <button class="btn" onclick="loadDemo()" title="Load Demo">🧪</button>
        </div>
      </header>

      <!-- Left Navigation -->
      <nav class="app-nav">
        <div class="nav-item active" data-view="ingest">
          <span>📁</span>
          <span>Ingest</span>
        </div>
        <div class="nav-item" data-view="validate">
          <span>✓</span>
          <span>Validate</span>
        </div>
        <div class="nav-item" data-view="analyze">
          <span>📊</span>
          <span>Analyze</span>
        </div>
        <div class="nav-item" data-view="forecast">
          <span>🔮</span>
          <span>Forecast</span>
        </div>
        <div class="nav-item" data-view="report">
          <span>📋</span>
          <span>Report</span>
        </div>
        <div class="nav-item" data-view="audit">
          <span>🔍</span>
          <span>Audit</span>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="app-main">
        <div class="page-header">
          <h1 class="page-title" id="pageTitle">Data Ingestion</h1>
          <div class="d-flex" style="gap: var(--s-2);">
            <button class="btn btn-primary" onclick="loadDemo()">Load Demo</button>
          </div>
        </div>

        <div class="page-content" id="mainContent">
          <div class="card">
            <div class="card-header">
              <h3>Welcome to FP&A Close Studio</h3>
            </div>
            <div class="card-body">
              <p>Modern, offline-first application for monthly financial close processes with Salesforce Lightning Design System.</p>
              <div class="scenario-board">
                <div class="scenario-card active">
                  <h4>Base Case</h4>
                  <div class="text-muted text-small mb-3">Conservative growth</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold">+5%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Upside</h4>
                  <div class="text-muted text-small mb-3">Optimistic scenario</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold">+15%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Downside</h4>
                  <div class="text-muted text-small mb-3">Conservative scenario</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold">-5%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Aside -->
      <aside class="app-aside">
        <div class="aside-section">
          <h3>Quick Help</h3>
          <div class="text-small text-muted mb-3">
            <strong>60-second quickstart:</strong>
            <ol style="margin: 8px 0; padding-left: 16px; font-size: 12px;">
              <li>Load demo data</li>
              <li>Run validation</li>
              <li>Create scenarios</li>
              <li>Generate reports</li>
            </ol>
          </div>
          <button class="btn btn-primary" style="width: 100%;" onclick="loadDemo()">Start Demo</button>
        </div>
        
        <div class="aside-section">
          <h3>Decision Log</h3>
          <div id="decisionLog" class="text-small">
            <div class="mb-3">
              <div class="font-weight-bold">System Initialized</div>
              <div class="text-muted text-small">Salesforce Lightning Design theme applied</div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Command Palette -->
    <div class="cmd-palette" id="commandPalette">
      <div class="cmd-palette-content">
        <input type="text" class="cmd-search" placeholder="Type a command..." id="cmdSearch">
        <div class="cmd-results" id="cmdResults"></div>
      </div>
    </div>

    <!-- Network Monitor -->
    <div class="network-badge" id="networkBadge">Network calls: 0</div>

    <script>
      // Core App State
      const AppState = {
        currentView: 'ingest',
        theme: localStorage.getItem('theme') || 'light',
        networkCalls: 0,
        decisions: []
      };

      // Initialize App
      document.addEventListener('DOMContentLoaded', initializeApp);

      function initializeApp() {
        setupTheme();
        setupNavigation();
        setupCommandPalette();
        setupNetworkMonitoring();
        logDecision('Application initialized with Salesforce Lightning Design System');
      }

      // Theme Management
      function setupTheme() {
        document.documentElement.setAttribute('data-theme', AppState.theme);
      }

      function toggleTheme() {
        AppState.theme = AppState.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', AppState.theme);
        document.documentElement.setAttribute('data-theme', AppState.theme);
        logDecision(`Theme switched to ${AppState.theme} mode`);
      }

      // Navigation
      function setupNavigation() {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', () => {
            const view = item.dataset.view;
            if (view) switchView(view);
          });
        });
      }

      function switchView(view) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.toggle('active', item.dataset.view === view);
        });
        
        AppState.currentView = view;
        updatePageTitle(view);
        renderViewContent(view);
        logDecision(`Switched to ${view} view`);
      }

      function updatePageTitle(view) {
        const titles = {
          ingest: 'Data Ingestion',
          validate: 'Validation & Reconciliation', 
          analyze: 'Analysis & Variance',
          forecast: 'Scenario Planning',
          report: 'Close Pack Generation',
          audit: 'Audit Trail'
        };
        document.getElementById('pageTitle').textContent = titles[view] || view;
      }

      function renderViewContent(view) {
        const content = document.getElementById('mainContent');
        
        switch(view) {
          case 'ingest':
            content.innerHTML = renderIngestView();
            break;
          case 'validate':
            content.innerHTML = renderValidateView();
            break;
          case 'analyze':
            content.innerHTML = renderAnalyzeView();
            break;
          case 'forecast':
            content.innerHTML = renderForecastView();
            break;
          case 'report':
            content.innerHTML = renderReportView();
            break;
          case 'audit':
            content.innerHTML = renderAuditView();
            break;
          default:
            content.innerHTML = renderDefaultView();
        }
      }

      // View Content Renderers
      function renderIngestView() {
        return `
          <div class="card">
            <div class="card-header">
              <h3>📁 Data Sources</h3>
            </div>
            <div class="card-body">
              <p>Import CSV and Excel files for analysis. Supports drag-and-drop and file picker.</p>
              
              <div style="border: 2px dashed var(--border); border-radius: var(--r-md); padding: var(--s-5); text-align: center; margin: var(--s-4) 0; background: var(--muted);">
                <div style="font-size: 48px; margin-bottom: var(--s-3);">📄</div>
                <h4>Drop files here or click to browse</h4>
                <p class="text-muted">Supports CSV, XLSX files up to 100MB</p>
                <button class="btn btn-primary" onclick="triggerFileUpload()">Browse Files</button>
              </div>

              <div class="scenario-board">
                <div class="scenario-card">
                  <h4>GL Data</h4>
                  <div class="text-muted text-small mb-3">General Ledger transactions</div>
                  <div class="d-flex justify-content-between">
                    <span>Status:</span>
                    <span class="font-weight-bold text-muted">No data</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Budget Data</h4>
                  <div class="text-muted text-small mb-3">Budget allocations and forecasts</div>
                  <div class="d-flex justify-content-between">
                    <span>Status:</span>
                    <span class="font-weight-bold text-muted">No data</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>CRM Data</h4>
                  <div class="text-muted text-small mb-3">Sales bookings and pipeline</div>
                  <div class="d-flex justify-content-between">
                    <span>Status:</span>
                    <span class="font-weight-bold text-muted">No data</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderValidateView() {
        return `
          <div class="card mb-4">
            <div class="card-header">
              <h3>✓ Validation Rules</h3>
            </div>
            <div class="card-body">
              <p>Run validation checks on imported data to identify exceptions and data quality issues.</p>
              
              <div class="d-flex gap-3 mb-4">
                <div class="form-group" style="flex: 1;">
                  <label class="form-label">Period Start</label>
                  <input type="date" class="form-input" value="2024-03-01">
                </div>
                <div class="form-group" style="flex: 1;">
                  <label class="form-label">Period End</label>
                  <input type="date" class="form-input" value="2024-03-31">
                </div>
                <div class="form-group" style="flex: 0 0 auto; align-self: end;">
                  <button class="btn btn-primary" onclick="runValidation()">Run Validation</button>
                </div>
              </div>

              <div class="scenario-board">
                <div class="scenario-card">
                  <h4>Data Quality</h4>
                  <div class="text-muted text-small mb-3">Missing fields, format issues</div>
                  <div class="d-flex justify-content-between">
                    <span>Issues Found:</span>
                    <span class="font-weight-bold" style="color: var(--warn);">0</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Business Rules</h4>
                  <div class="text-muted text-small mb-3">Duplicates, outliers, logic checks</div>
                  <div class="d-flex justify-content-between">
                    <span>Exceptions:</span>
                    <span class="font-weight-bold" style="color: var(--ok);">0</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Reconciliation</h4>
                  <div class="text-muted text-small mb-3">Sub-ledger to GL tie-outs</div>
                  <div class="d-flex justify-content-between">
                    <span>Variances:</span>
                    <span class="font-weight-bold text-muted">Pending</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAnalyzeView() {
        return `
          <div class="card mb-4">
            <div class="card-header">
              <h3>📊 Variance Analysis</h3>
            </div>
            <div class="card-body">
              <p>Compare actual results against budget and prior periods. Identify trends and outliers.</p>
              
              <div class="d-flex gap-3 mb-4">
                <div class="form-group">
                  <label class="form-label">Analysis Period</label>
                  <input type="month" class="form-input" value="2024-03">
                </div>
                <div class="form-group">
                  <label class="form-label">Comparison</label>
                  <select class="form-input">
                    <option>Budget vs Actual</option>
                    <option>MoM Variance</option>
                    <option>YoY Variance</option>
                  </select>
                </div>
                <div class="form-group" style="align-self: end;">
                  <button class="btn btn-primary" onclick="runAnalysis()">Run Analysis</button>
                </div>
              </div>

              <div style="height: 300px; background: var(--muted); border-radius: var(--r-md); display: flex; align-items: center; justify-content: center; margin: var(--s-4) 0;">
                <div style="text-align: center; color: var(--text-muted);">
                  <div style="font-size: 48px; margin-bottom: var(--s-2);">📈</div>
                  <h4>Variance Chart</h4>
                  <p>Load data and run analysis to see variance waterfall</p>
                </div>
              </div>

              <div class="scenario-board">
                <div class="scenario-card active">
                  <h4>Revenue Variance</h4>
                  <div class="text-muted text-small mb-3">Actual vs Budget comparison</div>
                  <div class="d-flex justify-content-between">
                    <span>Variance:</span>
                    <span class="font-weight-bold" style="color: var(--ok);">+2.3%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Expense Variance</h4>
                  <div class="text-muted text-small mb-3">Operating expense analysis</div>
                  <div class="d-flex justify-content-between">
                    <span>Variance:</span>
                    <span class="font-weight-bold" style="color: var(--warn);">-1.8%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Margin Analysis</h4>
                  <div class="text-muted text-small mb-3">Gross and operating margins</div>
                  <div class="d-flex justify-content-between">
                    <span>Trend:</span>
                    <span class="font-weight-bold" style="color: var(--ok);">Improving</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderForecastView() {
        return `
          <div class="card mb-4">
            <div class="card-header">
              <h3>🔮 Scenario Planning</h3>
            </div>
            <div class="card-body">
              <p>Create and compare multiple forecast scenarios. Build driver-based models for planning.</p>
              
              <div class="d-flex gap-3 mb-4">
                <div class="form-group">
                  <label class="form-label">Forecast Period</label>
                  <input type="month" class="form-input" value="2024-04">
                </div>
                <div class="form-group">
                  <label class="form-label">Scenario</label>
                  <select class="form-input">
                    <option>Scenario A - Base Case</option>
                    <option>Scenario B - Upside</option>
                    <option>Scenario C - Downside</option>
                  </select>
                </div>
                <div class="form-group" style="align-self: end;">
                  <button class="btn btn-primary" onclick="runForecast()">Run Forecast</button>
                </div>
              </div>

              <div class="scenario-board">
                <div class="scenario-card active">
                  <h4>Base Case</h4>
                  <div class="text-muted text-small mb-3">Conservative growth assumptions</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold">+5%</span>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <span>COGS %:</span>
                    <span class="font-weight-bold">25%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Upside</h4>
                  <div class="text-muted text-small mb-3">Optimistic market conditions</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold" style="color: var(--ok);">+15%</span>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <span>COGS %:</span>
                    <span class="font-weight-bold">24%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Downside</h4>
                  <div class="text-muted text-small mb-3">Economic headwinds</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold" style="color: var(--warn);">-5%</span>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <span>COGS %:</span>
                    <span class="font-weight-bold">28%</span>
                  </div>
                </div>
              </div>

              <div style="margin-top: var(--s-5);">
                <h4>Driver Inputs</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--s-4); margin-top: var(--s-3);">
                  <div class="form-group">
                    <label class="form-label">Revenue Growth %</label>
                    <input type="number" class="form-input" value="5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">COGS % of Revenue</label>
                    <input type="number" class="form-input" value="25" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Headcount Change</label>
                    <input type="number" class="form-input" value="0">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Comp Increase %</label>
                    <input type="number" class="form-input" value="0" step="0.1">
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderReportView() {
        return `
          <div class="card mb-4">
            <div class="card-header">
              <h3>📋 Close Pack Generation</h3>
            </div>
            <div class="card-body">
              <p>Generate professional close pack reports for executive review and board presentations.</p>
              
              <div class="d-flex gap-3 mb-4">
                <div class="form-group">
                  <label class="form-label">Report Period</label>
                  <input type="month" class="form-input" value="2024-03">
                </div>
                <div class="form-group">
                  <label class="form-label">Template</label>
                  <select class="form-input">
                    <option>Executive Summary</option>
                    <option>Board Package</option>
                    <option>Variance Report</option>
                    <option>KPI Dashboard</option>
                  </select>
                </div>
                <div class="form-group" style="align-self: end;">
                  <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                </div>
              </div>

              <div class="scenario-board">
                <div class="scenario-card">
                  <h4>Executive Summary</h4>
                  <div class="text-muted text-small mb-3">High-level financial overview</div>
                  <div class="d-flex justify-content-between">
                    <span>Status:</span>
                    <span class="font-weight-bold text-muted">Ready</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>KPI Table</h4>
                  <div class="text-muted text-small mb-3">Key performance indicators</div>
                  <div class="d-flex justify-content-between">
                    <span>Metrics:</span>
                    <span class="font-weight-bold">15</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Variance Bridges</h4>
                  <div class="text-muted text-small mb-3">Waterfall analysis charts</div>
                  <div class="d-flex justify-content-between">
                    <span>Charts:</span>
                    <span class="font-weight-bold">5</span>
                  </div>
                </div>
              </div>

              <div style="height: 200px; background: var(--muted); border-radius: var(--r-md); display: flex; align-items: center; justify-content: center; margin: var(--s-4) 0;">
                <div style="text-align: center; color: var(--text-muted);">
                  <div style="font-size: 48px; margin-bottom: var(--s-2);">📄</div>
                  <h4>Report Preview</h4>
                  <p>Generate report to see PDF preview</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAuditView() {
        return `
          <div class="card mb-4">
            <div class="card-header">
              <h3>🔍 Audit Trail</h3>
            </div>
            <div class="card-body">
              <p>Complete audit trail of all activities, decisions, and data transformations with SHA-256 hashes.</p>
              
              <div class="d-flex gap-3 mb-4">
                <div class="form-group">
                  <label class="form-label">Export Period</label>
                  <input type="month" class="form-input" value="2024-03">
                </div>
                <div class="form-group">
                  <label class="form-label">Format</label>
                  <select class="form-input">
                    <option>CSV (Detailed)</option>
                    <option>JSON (Raw)</option>
                    <option>PDF (Summary)</option>
                  </select>
                </div>
                <div class="form-group" style="align-self: end;">
                  <button class="btn btn-primary" onclick="exportAuditLog()">Export Audit</button>
                </div>
              </div>

              <div class="scenario-board">
                <div class="scenario-card">
                  <h4>Data Snapshots</h4>
                  <div class="text-muted text-small mb-3">Immutable data versions</div>
                  <div class="d-flex justify-content-between">
                    <span>Count:</span>
                    <span class="font-weight-bold">3</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Decision Log</h4>
                  <div class="text-muted text-small mb-3">User actions and choices</div>
                  <div class="d-flex justify-content-between">
                    <span>Entries:</span>
                    <span class="font-weight-bold">${AppState.decisions.length}</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Transformations</h4>
                  <div class="text-muted text-small mb-3">Data processing steps</div>
                  <div class="d-flex justify-content-between">
                    <span>Operations:</span>
                    <span class="font-weight-bold">12</span>
                  </div>
                </div>
              </div>

              <div style="background: var(--panel); border: 1px solid var(--border); border-radius: var(--r-md); padding: var(--s-4); margin-top: var(--s-4);">
                <h4>Recent Activity</h4>
                <div style="max-height: 200px; overflow-y: auto; margin-top: var(--s-3);">
                  ${AppState.decisions.slice(-5).map(decision => `
                    <div class="d-flex justify-content-between mb-3" style="padding: var(--s-2); background: var(--muted); border-radius: var(--r-sm);">
                      <span class="text-small">${decision.text}</span>
                      <span class="text-small text-muted">${decision.timestamp}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderDefaultView() {
        return `
          <div class="card">
            <div class="card-header">
              <h3>Welcome to FP&A Close Studio</h3>
            </div>
            <div class="card-body">
              <p>Modern, offline-first application for monthly financial close processes with Salesforce Lightning Design System.</p>
              <div class="scenario-board">
                <div class="scenario-card active">
                  <h4>Base Case</h4>
                  <div class="text-muted text-small mb-3">Conservative growth</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold">+5%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Upside</h4>
                  <div class="text-muted text-small mb-3">Optimistic scenario</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold">+15%</span>
                  </div>
                </div>
                <div class="scenario-card">
                  <h4>Downside</h4>
                  <div class="text-muted text-small mb-3">Conservative scenario</div>
                  <div class="d-flex justify-content-between">
                    <span>Revenue Growth:</span>
                    <span class="font-weight-bold">-5%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Command Palette with 50-line Fuzzy Search
      const COMMANDS = [
        { id: 'import', label: 'Import Files', keywords: 'upload data csv xlsx' },
        { id: 'demo', label: 'Load Demo Data', keywords: 'sample test example' },
        { id: 'validate', label: 'Run Validation', keywords: 'check rules exceptions' },
        { id: 'exceptions', label: 'Open Exceptions Queue', keywords: 'errors triage fix' },
        { id: 'forecast', label: 'Create Scenario', keywords: 'projection planning future' },
        { id: 'variance', label: 'Variance Analysis', keywords: 'budget actual difference' },
        { id: 'closepack', label: 'Generate Close Pack', keywords: 'report pdf executive' },
        { id: 'audit', label: 'Export Audit Log', keywords: 'trail history csv' },
        { id: 'theme', label: 'Toggle Theme', keywords: 'dark light mode' },
        { id: 'help', label: 'Show Help', keywords: 'support documentation' }
      ];

      function setupCommandPalette() {
        document.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            toggleCommandPalette();
          }
          if (e.key === 'Escape') {
            hideCommandPalette();
          }
        });

        const cmdSearch = document.getElementById('cmdSearch');
        cmdSearch.addEventListener('input', filterCommands);
        cmdSearch.addEventListener('keydown', handleCommandNavigation);
      }

      function toggleCommandPalette() {
        const palette = document.getElementById('commandPalette');
        if (palette.classList.contains('active')) {
          hideCommandPalette();
        } else {
          palette.classList.add('active');
          document.getElementById('cmdSearch').focus();
          renderCommands(COMMANDS);
        }
      }

      function hideCommandPalette() {
        document.getElementById('commandPalette').classList.remove('active');
        document.getElementById('cmdSearch').value = '';
      }

      // Fuzzy Search Implementation (50 lines)
      function fuzzyScore(query, text, keywords = '') {
        const searchText = (text + ' ' + keywords).toLowerCase();
        query = query.toLowerCase();
        
        if (!query) return 1;
        if (searchText.includes(query)) return 0.9;
        
        let score = 0;
        let queryIndex = 0;
        let bonus = 0;
        
        for (let i = 0; i < searchText.length && queryIndex < query.length; i++) {
          if (searchText[i] === query[queryIndex]) {
            score += 1 + bonus;
            bonus = Math.min(bonus + 0.1, 1);
            queryIndex++;
          } else {
            bonus = 0;
          }
        }
        
        return queryIndex === query.length ? score / query.length : 0;
      }

      function filterCommands() {
        const query = document.getElementById('cmdSearch').value;
        const scored = COMMANDS.map(cmd => ({
          ...cmd,
          score: fuzzyScore(query, cmd.label, cmd.keywords)
        })).filter(cmd => cmd.score > 0).sort((a, b) => b.score - a.score);
        
        renderCommands(scored);
      }

      function renderCommands(commands) {
        const results = document.getElementById('cmdResults');
        results.innerHTML = commands.map((cmd, index) => `
          <div class="cmd-item ${index === 0 ? 'selected' : ''}" data-command="${cmd.id}">
            <span>${cmd.label}</span>
          </div>
        `).join('');

        results.querySelectorAll('.cmd-item').forEach(item => {
          item.addEventListener('click', () => executeCommand(item.dataset.command));
        });
      }

      function handleCommandNavigation(e) {
        const items = document.querySelectorAll('.cmd-item');
        const selected = document.querySelector('.cmd-item.selected');
        let currentIndex = Array.from(items).indexOf(selected);

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          currentIndex = Math.min(currentIndex + 1, items.length - 1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          currentIndex = Math.max(currentIndex - 1, 0);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selected) executeCommand(selected.dataset.command);
          return;
        }

        items.forEach((item, index) => {
          item.classList.toggle('selected', index === currentIndex);
        });
      }

      function executeCommand(commandId) {
        const actions = {
          import: () => alert('File import would open here'),
          demo: () => loadDemo(),
          validate: () => { switchView('validate'); alert('Validation running...'); },
          exceptions: () => switchView('validate'),
          forecast: () => switchView('forecast'),
          variance: () => switchView('analyze'),
          closepack: () => { switchView('report'); alert('Generating Close Pack...'); },
          audit: () => { switchView('audit'); alert('Exporting audit log...'); },
          theme: () => toggleTheme(),
          help: () => alert('Help documentation would open here')
        };

        if (actions[commandId]) {
          actions[commandId]();
          hideCommandPalette();
          logDecision(`Command executed: ${COMMANDS.find(c => c.id === commandId)?.label}`);
        }
      }

      // Network Monitoring
      function setupNetworkMonitoring() {
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          AppState.networkCalls++;
          updateNetworkBadge();
          return originalFetch.apply(this, args);
        };

        const OriginalXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = function() {
          const xhr = new OriginalXHR();
          const originalOpen = xhr.open;
          xhr.open = function() {
            AppState.networkCalls++;
            updateNetworkBadge();
            return originalOpen.apply(this, arguments);
          };
          return xhr;
        };
      }

      function updateNetworkBadge() {
        const badge = document.getElementById('networkBadge');
        badge.textContent = `Network calls: ${AppState.networkCalls}`;
        badge.style.background = AppState.networkCalls > 0 ? 'var(--warn)' : 'var(--ok)';
      }

      // Decision Logging
      function logDecision(text) {
        const timestamp = new Date().toLocaleString();
        AppState.decisions.push({ text, timestamp });
        
        const logContainer = document.getElementById('decisionLog');
        const entry = document.createElement('div');
        entry.className = 'mb-3';
        entry.innerHTML = `
          <div class="font-weight-bold text-small">${text}</div>
          <div class="text-muted" style="font-size: 11px;">${timestamp}</div>
        `;
        logContainer.appendChild(entry);
        
        // Keep only last 10 entries
        while (logContainer.children.length > 10) {
          logContainer.removeChild(logContainer.firstChild);
        }
      }

      // Demo Functions
      function loadDemo() {
        logDecision('Demo workspace loaded - Salesforce Lightning theme active');
        alert('Demo data loaded! Navigate between sections using the left menu or ⌘K command palette.');
      }

      // Action Functions for View Interactions
      function triggerFileUpload() {
        logDecision('File upload triggered');
        alert('File picker would open here. Supports CSV and XLSX files.');
      }

      function runValidation() {
        logDecision('Validation process started');
        alert('Running validation rules on imported data...');
      }

      function runAnalysis() {
        logDecision('Variance analysis initiated');
        alert('Analyzing variances between actual and budget data...');
      }

      function runForecast() {
        logDecision('Forecast calculation started');
        alert('Running forecast models with current driver assumptions...');
      }

      function generateReport() {
        logDecision('Close pack generation initiated');
        alert('Generating professional close pack report...');
      }

      // Accessibility
      document.addEventListener('keydown', (e) => {
        // Tab trapping for modal dialogs would go here
        if (e.key === 'Tab' && document.querySelector('.cmd-palette.active')) {
          // Focus management for command palette
        }
      });
    </script>
  </body>
</html>
